import zipfile
import shutil
import os
import pandas as pd

# ---- Read Excel Sheet 3 ----
excel_file = r"path\to\your\file.xlsx"     # <-- mee Excel path ikkad ivvali
df = pd.read_excel(excel_file, sheet_name="Sheet3")

# Convert Excel rows into dictionary
inputs = {}
for idx, row in df.iterrows():
    key = str(row['Action']).strip()
    value = str(row['Inputs']).strip()
    inputs[key] = value

# Extract required paths
zip_path = inputs.get("zip_path")
target_folder = inputs.get("Target_folder")
backup_folder = inputs.get("Backup_folder")

# Temporary extract location
extract_to = os.path.join(os.path.dirname(zip_path), "temp_extract")

print("Excel Inputs Loaded:")
print("Zip File:", zip_path)
print("Target Folder:", target_folder)
print("Backup Folder:", backup_folder)
print("Extract To:", extract_to)
print("--------------------------")

# ---- 1. Unzip the file ----
print("Unzipping...")
if os.path.exists(extract_to):
    shutil.rmtree(extract_to)
with zipfile.ZipFile(zip_path, 'r') as zip_ref:
    zip_ref.extractall(extract_to)
print("Unzip Complete!\n")

# ---- 2. Backup Target Folder ----
print("Taking Backup...")
if os.path.exists(backup_folder):
    shutil.rmtree(backup_folder)
shutil.copytree(target_folder, backup_folder)
print("Backup Complete!\n")

# ---- 3. Delete Files In Target Folder ----
print("Deleting files from target folder...")
for root, dirs, files in os.walk(target_folder):
    for file in files:
        os.remove(os.path.join(root, file))
print("Deletion Complete!\n")

# ---- 4. Copy Extracted Files ----
print("Copying extracted files to target folder...")
for root, dirs, files in os.walk(extract_to):
    rel_path = os.path.relpath(root, extract_to)
    dest_path = os.path.join(target_folder, rel_path)

    if not os.path.exists(dest_path):
        os.makedirs(dest_path)

    for file in files:
        shutil.copy2(os.path.join(root, file), os.path.join(dest_path, file))

print("âœ” All Steps Completed Successfully!")
