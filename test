# ------------------------------------------------------------
# IMPROVED DOWNLOAD FUNCTION
# ------------------------------------------------------------
def download_PAK_file(driver, file_name):
    logging.info(f" Searching for file: {file_name} to download...")
    try:
        file_element = WebDriverWait(driver, 30).until(
            EC.presence_of_element_located(
                (By.XPATH, f"//span[contains(@aria-labelledby, 'genfilename') and normalize-space(text())='{file_name}']")
            )
        )
        driver.execute_script("arguments[0].scrollIntoView(true);", file_element)
        time.sleep(1)
        driver.execute_script("arguments[0].click();", file_element)
        logging.info(f" File '{file_name}' selected, waiting for download icon...")

        # Locate the download icon associated with that file row
        download_icon_xpath = f"//span[normalize-space(text())='{file_name}']/ancestor::tr//i[contains(@class,'fa-download')]"
        download_button = WebDriverWait(driver, 20).until(
            EC.element_to_be_clickable((By.XPATH, download_icon_xpath))
        )

        # Try a JavaScript click first, fallback to ActionChains
        try:
            driver.execute_script("arguments[0].click();", download_button)
        except:
            from selenium.webdriver.common.action_chains import ActionChains
            ActionChains(driver).move_to_element(download_button).click().perform()

        logging.info(f" Download click triggered for file: '{file_name}'")

        # Wait for file to appear in Downloads
        download_path = get_download_path()
        file_path = os.path.join(download_path, file_name)
        logging.info(f" Waiting for '{file_name}' to appear in {download_path}...")

        wait_time = 0
        while wait_time < 120:
            if os.path.exists(file_path):
                logging.info(f"Download complete: '{file_name}' found in {download_path}")
                return file_path
            time.sleep(5)
            wait_time += 5

        logging.error(f"Download timeout: '{file_name}' not found after 120s.")
        sys.exit()

    except Exception as e:
        logging.error(f"Error: Unable to download file '{file_name}' - {e}")
        sys.exit()
