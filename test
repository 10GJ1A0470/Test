# ===============================
# Kill Event Monitor (PROD instance)
# ===============================

$Server = "AWSDMLNVAW000D"   

try {
    Write-Host "Looking for Event Monitor PROD process on $Server ..." -ForegroundColor Cyan

    # Get processes where CommandLine has both 'Event Monitor' and 'PROD'
    $PRODProc = Invoke-Command -ComputerName $Server -ScriptBlock {
        Get-CimInstance Win32_Process |
            Where-Object { $_.CommandLine -match "Event\s*Monitor" -and $_.CommandLine -match "PROD" } |
            Select-Object ProcessId, Name, CommandLine, @{Name="User";Expression={ ($_.GetOwner()).User }}, CreationDate
    }

    if (-not $PRODProc) {
        Write-Host "[$Server] - No PROD Event Monitor process found." -ForegroundColor Yellow
    }
    else {
        foreach ($proc in $PRODProc) {
            # Kill process directly by PID
            Invoke-Command -ComputerName $Server -ScriptBlock {
                param($ProcId)
                Stop-Process -Id $ProcId -Force -ErrorAction Stop
            } -ArgumentList $proc.ProcessId

            Write-Host "[$Server] - PROD Event Monitor (PID $($proc.ProcessId)) killed." -ForegroundColor Green
            Write-Host "    User       : $($proc.User)"
            Write-Host "    CommandLine: $($proc.CommandLine)"
            Write-Host "    Started On : $($proc.CreationDate)"
            Write-Host ""
        }
    }
}
catch {
    Write-Host "[$Server] - Error while killing PROD Event Monitor. $_" -ForegroundColor Red
}
