$Server = "AWSDROIRLW0009"
$TargetUser = "SA-ITS-APSPHINT-LAB"

Write-Host "Checking for 'ompeditor' process on $Server ..." -ForegroundColor Cyan

try {
    $procList = Invoke-Command -ComputerName $Server -ScriptBlock {
        Get-CimInstance Win32_Process | 
            Where-Object { $_.Name -match "ompeditor" } |
            Select-Object ProcessId, Name, CommandLine,
                @{Name="User"; Expression = { ($_.GetOwner()).User }},
                CreationDate
    }

    # Filter locally â€” DO NOT use $using:
    $matched = $procList | Where-Object { $_.User -eq $TargetUser }

    if (!$matched) {
        Write-Host "No jobs running." -ForegroundColor Yellow
        exit
    }

    foreach ($p in $matched) {
        Write-Host ""
        Write-Host "Process found:" -ForegroundColor Green
        Write-Host "   PID         : $($p.ProcessId)"
        Write-Host "   Name        : $($p.Name)"
        Write-Host "   User        : $($p.User)"
        Write-Host "   Started On  : $($p.CreationDate)"
        Write-Host "   CommandLine : $($p.CommandLine)"
        Write-Host ""
    }
}
catch {
    Write-Host "Error connecting to server or fetching process. $_" -ForegroundColor Red
}

exit
