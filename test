import shutil
import sys

def replace_with_backup(source_path, target_path):
    try:
        source = Path(source_path)
        target = Path(target_path)

        if not source.exists():
            logging.error(f"Source folder does not exist: {source}")
            sys.exit("Source folder missing. Exiting...")

        # Create global backup directory if missing
        backup_root = Path("D:/Backup")
        if not backup_root.exists():
            logging.info("Backup root folder D:/Backup not found. Creating now...")
            backup_root.mkdir(parents=True, exist_ok=True)

        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        target_folder_name = target.name
        backup_path = backup_root / f"{target_folder_name}_{timestamp}"

        # 1. Backup target path if exists
        if target.exists():
            try:
                logging.info(f"Backing up target folder to: {backup_path}")
                shutil.copytree(target, backup_path)
            except Exception as e:
                logging.error(f"Backup failed: {e}")
                sys.exit("Backup failed. Exiting...")

            # 2. Delete target folder
            try:
                logging.info(f"Deleting target folder: {target}")
                shutil.rmtree(target)
            except Exception as e:
                logging.error(f"Failed to delete target folder: {e}")
                sys.exit("Target deletion failed. Exiting...")
        else:
            logging.info("Target folder does not exist. Skipping backup/delete.")

        # 3. MOVE source → target (FASTER)
        try:
            logging.info(f"Moving source folder {source} → {target}")
            shutil.move(str(source), str(target))
        except Exception as e:
            logging.error(f"Move failed: {e}")
            sys.exit("Move failed. Exiting...")

        logging.info("Folder replacement (MOVE) completed successfully.")

    except Exception as e:
        logging.error(f"Unexpected error in replace_with_backup(): {e}")
        sys.exit("Unexpected error. Exiting...")
