import pyautogui
from pyautogui import getWindowsWithTitle
import pyperclip
import time
import subprocess
import re
import os
import logging
import pandas as pd
import pygetwindow as gw
import socket

host_server = socket.gethostname().upper()
time.sleep(1)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    handlers=[logging.StreamHandler()]
)

# Helper Functions

def wait_for_cmd_window(timeout=30):
    start = time.time()
    while time.time() - start < timeout:
        for win in gw.getWindowsWithTitle(""):
            if win.title.startswith("Administrator:"):
                return True
        time.sleep(1)
    return False

def click_inside_rdp_window(title_keyword):
    x=530
    y=280
    pyautogui.moveTo(x, y)
    time.sleep(0.5)
    pyautogui.click()        
    logging.info(f"Clicked inside RDP window at ({x}, {y})")

def query_session(server):
    if server==host_server:
        output = subprocess.run("query session",capture_output=True,text=True,shell=True).stdout
    else:
        # ---------------- Session Check ------------------
        session_cmd = "query session"
        #session_cmd = "hostname"
        pyperclip.copy(session_cmd)
        pyautogui.keyDown('ctrl')
        time.sleep(1)
        pyautogui.press('v')
        time.sleep(0.5)
        pyautogui.keyUp('ctrl')
        time.sleep(0.5)
        pyautogui.press('enter')
        time.sleep(4)

        # Copy the Session Data
        pyautogui.keyDown('ctrl')
        time.sleep(1)
        pyautogui.press('a')
        time.sleep(0.5)
        pyautogui.press('c')
        time.sleep(0.5)
        pyautogui.keyUp('ctrl')

        # Paste Data for Parsing
        output = pyperclip.paste()

    session_lines = output.strip().splitlines()
    current_session_id = None
    sessions_to_logoff = []
    excluded_users = ['services','DWM-1','DWM-2','UMFD-0','UMFD-1','SYSTEM','Administrator']

    for line in session_lines:
        match = re.search(r'^\s*(\S+)?\s+(\S+)\s+(\d+)\s+(Active|Disc)\b',line)
        if match:
            session_name, user, session_id, state = match.groups()
            if username.lower().split('\\')[-1] in line.lower():
                current_session_id = (session_name, user, session_id, state)
            else:
                if user not in excluded_users:
                    sessions_to_logoff.append((session_name, user, session_id, state))

    # Log off other sessions
    for session in sessions_to_logoff:
        logging.info(f'Logging off Session:{session[0]} User:{session[1]} ID:{session[2]} State:{session[3]}')
        
        if server == host_server:
            subprocess.run(f'logoff {session[2]}')
        else:
            cmd = f'logoff {session[2]}'
            pyperclip.copy(cmd)
            pyautogui.keyDown('ctrl')
            time.sleep(1)
            pyautogui.press('v')
            time.sleep(0.5)
            pyautogui.keyUp('ctrl')
            time.sleep(0.5)
            pyautogui.press('enter')
        time.sleep(5)

    # Log off current session
    if server == host_server:
        return f"Logged off all users except current on {host_server}"
    
    if current_session_id:
        session = current_session_id
        logging.info(f'Logging off Current Session:{session[0]} User:{session[1]} ID:{session[2]} State:{session[3]}')
        cmd = f'logoff {session[2]}'
        pyperclip.copy(cmd)
        pyautogui.keyDown('ctrl')
        time.sleep(1)
        pyautogui.press('v')
        time.sleep(0.5)
        pyautogui.keyUp('ctrl')
        time.sleep(0.5)
        pyautogui.press('enter')
        time.sleep(4)

    return f"Logged Off all users Successfully on {server}!"

username = r"JNJ\SA-ITS-APSMDAUT-PRD"
password = os.getenv('OMP_key')

# Server List
dir = r'\\awsusdmkfsxn01.jnj.com\mdd_prd_omp\Automation_Scripts\Atom_SPPROD_Scripts\Parameter_Change\log'
with open(dir + r'\userlist_servers.txt', 'r') as file:
    server_list = [line.strip() for line in file]

count = len(server_list)

for _ in range(3):
    failed_list = []
    temp_count=0

    for server in server_list:
        time.sleep(20)
        logging.info(f'Current Server: {server}')
        machineName = server
        rdp_file = "rdp_conn.rdp"

        if server == host_server:
            logging.info(query_session(server))
            continue

        # Store credentials
        subprocess.run(f'cmdkey /generic:TERMSRV/{machineName} /user:{username} /pass:{password}', shell=True)
        time.sleep(10)

        # Write RDP file
        with open(rdp_file, "w", encoding="utf-16") as f:
            f.write(f'''screen mode id:i:2
    use multimon:i:0
    desktopwidth:i:1366
    desktopheight:i:768
    session bpp:i:32
    winposstr:s:0,3,0,0,800,600
    compression:i:1
    keyboardhook:i:2
    audiocapturemode:i:0
    videoplaybackmode:i:1
    connection type:i:7
    networkautodetect:i:1
    bandwidthautodetect:i:1
    displayconnectionbar:i:1
    enableworkspacereconnect:i:0
    disable wallpaper:i:0
    allow font smoothing:i:0
    allow desktop composition:i:0
    disable full window drag:i:1
    disable menu anims:i:1
    disable themes:i:0
    disable cursor setting:i:0
    bitmapcachepersistenable:i:1
    full address:s:{machineName}
    audiomode:i:0
    redirectprinters:i:1
    redirectlocation:i:0
    redirectcomports:i:0
    redirectsmartcards:i:1
    redirectwebauthn:i:1
    redirectclipboard:i:1
    redirectposdevices:i:0
    autoreconnection enabled:i:1
    authentication level:i:2
    prompt for credentials:i:0
    negotiate security layer:i:1
    remoteapplicationmode:i:0
    alternate shell:s:
    shell working directory:s:
    gatewayhostname:s:
    gatewayusagemethod:i:4
    gatewaycredentialssource:i:4
    gatewayprofileusagemethod:i:0
    promptcredentialonce:i:0
    gatewaybrokeringtype:i:0
    use redirection server name:i:0
    rdgiskdcproxy:i:0
    kdcproxyname:s:
    enablerdsaadauth:i:0
    ''')

        # Launch RDP
        subprocess.Popen(["mstsc.exe", "/admin", rdp_file])
        logging.info("Launching RDP session...")
        time.sleep(8)

        # Accept initial popups
        pyautogui.press('tab')
        time.sleep(2)
        pyautogui.press('tab')
        time.sleep(2)
        pyautogui.press('enter')
        time.sleep(20)

        # Wait for RDP window to load
        max_wait = 30
        start = time.time()
        while True:
            if getWindowsWithTitle(machineName):
                click_inside_rdp_window(machineName)
                pyautogui.press('enter')  # Info/warning
                time.sleep(20)
                click_inside_rdp_window(machineName)
                
                # ---------------- CMD Launch ------------------
                pyautogui.press('win')
                time.sleep(2)
                pyautogui.write("run",interval=0.2)
                time.sleep(5)
                pyautogui.press('enter')
                time.sleep(2)

                pyautogui.moveTo(140, 560)
                time.sleep(1)
                pyautogui.click()

                pyautogui.write("cmd",interval=0.2)
                #pyautogui.press('enter')
                pyautogui.keyDown('ctrl')
                time.sleep(1)
                pyautogui.keyDown('shift')
                time.sleep(1)
                pyautogui.press('enter')
                time.sleep(0.5)
                pyautogui.keyUp('ctrl')
                pyautogui.keyUp('shift')
                time.sleep(3)

                pyautogui.press('tab')
                time.sleep(2)
                pyautogui.press('tab')
                time.sleep(2)
                pyautogui.press('enter')
                time.sleep(10)

                click_inside_rdp_window(machineName)
                
                logging.info(query_session(server))

                #RDP Window Close Confirmation
                temp=time.time()
                while True:
                    if not getWindowsWithTitle(machineName):
                        logging.info(f"{machineName} window closed successfully!")
                        break
                    
                    if time.time() - temp > max_wait:
                        logging.error(f"Failed to Logoff {machineName}")
                        failed_list.append(machineName)
                        break
                    
                    time.sleep(1)

                # Clean up
                subprocess.run(f'cmdkey /delete:TERMSRV/{machineName}', shell=True)
                os.remove(rdp_file)
                time.sleep(2)
                break

            
            if time.time() - start > max_wait:
                logging.error(f"Failed to RDP Login {machineName}")
                failed_list.append(machineName)
                break

            time.sleep(1)

        temp_count += 1

    # Final logging
    logging.info(f'Completed the Task for {temp_count - len(failed_list)} Servers Successfully!')
    logging.info(f'Failed to Connect {len(failed_list)} Servers:\n')

    if len(failed_list)>0:
        log_file = dir + r"\failed_serverlist.log"
        open(log_file, 'w').close()
        with open(log_file, 'a') as f:
            for item in failed_list:
                f.write(f"{item}\n")
        logging.info(f"Failed Logs saved in {log_file}")
        server_list = failed_list
    else:
        break

logging.info(f'Completed the Task for Total {count - len(failed_list)} Servers Successfully!')
