param(
    [string]$Server   = "AWS******009",
    [string]$UserName = "SA_****_PRD",
    [pscredential]$Credential = $null
)

function Write-Log {
    param([string]$msg)
    Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $msg"
}

Write-Log "Checking server '$Server' for username '$UserName'..."

try {
    $sess = New-CimSession -ComputerName $Server -Credential $Credential -ErrorAction Stop
    $procs = Get-CimInstance -ClassName Win32_Process -CimSession $sess

    foreach ($p in $procs) {

        # check process name contains 'ompplus'
        if ($p.Name -notlike "*ompplus*") { continue }

        # get owner
        $ownerInfo = Invoke-CimMethod -InputObject $p -MethodName GetOwner -CimSession $sess -ErrorAction SilentlyContinue
        if ($ownerInfo -eq $null) { continue }

        $ownerUser = $ownerInfo.User.ToLower()
        $targetUser = $UserName.ToLower()

        # user match?
        if ($ownerUser -eq $targetUser) {

            Write-Host "------------------------------------" -ForegroundColor Yellow
            Write-Host "MATCH FOUND on $Server" -ForegroundColor Green
            Write-Host "User        : $ownerUser"
            Write-Host "Process     : $($p.Name)"
            Write-Host "PID         : $($p.ProcessId)"
            Write-Host "CommandLine : $($p.CommandLine)"
            Write-Host "------------------------------------" -ForegroundColor Yellow
        }
    }

    Remove-CimSession $sess
}
catch {
    Write-Log "ERROR: Unable to connect to $Server : $_"
}
